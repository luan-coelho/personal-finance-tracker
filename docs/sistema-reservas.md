# üéØ Sistema de Reservas (Caixinhas) - Implementa√ß√£o Completa

## üìã Vis√£o Geral

Sistema completo de "caixinhas" ou "reservas financeiras" que permite aos usu√°rios criar compartimentos separados para organizar seu dinheiro e registrar movimenta√ß√µes (dep√≥sitos e retiradas).

##‚úÖ Funcionalidades Implementadas

### 1. **Gerenciamento de Reservas**

- ‚úÖ Criar reservas personalizadas com nome, descri√ß√£o, cor e √≠cone
- ‚úÖ Definir metas financeiras opcionais
- ‚úÖ Acompanhar saldo atual automaticamente
- ‚úÖ Ativar/desativar reservas
- ‚úÖ Editar e excluir reservas
- ‚úÖ Visualiza√ß√£o em cards com progresso

### 2. **Movimenta√ß√µes**

- ‚úÖ Registrar dep√≥sitos (adicionar dinheiro)
- ‚úÖ Registrar retiradas (retirar dinheiro)
- ‚úÖ Hist√≥rico completo de movimenta√ß√µes
- ‚úÖ Atualiza√ß√£o autom√°tica do saldo
- ‚úÖ Valida√ß√£o de saldo insuficiente
- ‚úÖ Excluir movimenta√ß√µes com reversa autom√°tica

### 3. **Integra√ß√£o com Espa√ßos**

- ‚úÖ Reservas vinculadas a espa√ßos
- ‚úÖ Controle de acesso via membros do espa√ßo
- ‚úÖ Editors podem criar/editar movimenta√ß√µes
- ‚úÖ Viewers apenas visualizam

## üóÑÔ∏è Estrutura do Banco de Dados

### Tabela: `reserves`

```sql
CREATE TABLE reserves (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  description TEXT,
  target_amount NUMERIC(10, 2),
  current_amount NUMERIC(10, 2) DEFAULT '0' NOT NULL,
  color TEXT DEFAULT '#3b82f6',
  icon TEXT DEFAULT 'piggy-bank',
  active BOOLEAN DEFAULT true NOT NULL,
  space_id UUID NOT NULL REFERENCES spaces(id) ON DELETE CASCADE,
  created_at TIMESTAMP DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMP
);
```

### Tabela: `reserve_movements`

```sql
CREATE TABLE reserve_movements (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  type reserve_movement_type NOT NULL, -- 'deposit' ou 'withdraw'
  amount NUMERIC(10, 2) NOT NULL,
  date TIMESTAMP NOT NULL,
  description TEXT,
  reserve_id UUID NOT NULL REFERENCES reserves(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  created_at TIMESTAMP DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMP
);

CREATE TYPE reserve_movement_type AS ENUM ('deposit', 'withdraw');
```

## üîå APIs Dispon√≠veis

### Reservas

#### `GET /api/reserves?spaceId={spaceId}`

Lista todas as reservas de um espa√ßo

**Query Params:**

- `spaceId` (required): ID do espa√ßo

**Response:**

```json
{
  "success": true,
  "data": [
    {
      "id": "uuid",
      "name": "Emerg√™ncia",
      "description": "Fundo de emerg√™ncia",
      "targetAmount": "10000.00",
      "currentAmount": "2500.00",
      "color": "#ef4444",
      "icon": "shield",
      "active": true,
      "spaceId": "uuid",
      "createdAt": "2024-01-01T00:00:00Z"
    }
  ]
}
```

#### `POST /api/reserves`

Cria uma nova reserva

**Request Body:**

```json
{
  "name": "F√©rias",
  "description": "Para pr√≥xima viagem",
  "targetAmount": "5000",
  "color": "#3b82f6",
  "icon": "plane",
  "spaceId": "uuid"
}
```

#### `PUT /api/reserves/[id]`

Atualiza uma reserva

#### `DELETE /api/reserves/[id]`

Exclui uma reserva

#### `PATCH /api/reserves/[id]/toggle`

Ativa/desativa uma reserva

### Movimenta√ß√µes

#### `GET /api/reserves/[id]/movements`

Lista movimenta√ß√µes de uma reserva

**Response:**

```json
{
  "success": true,
  "data": [
    {
      "id": "uuid",
      "type": "deposit",
      "amount": "500.00",
      "date": "2024-01-01T00:00:00Z",
      "description": "Dep√≥sito inicial",
      "reserveId": "uuid",
      "userId": "uuid",
      "reserve": {
        "id": "uuid",
        "name": "Emerg√™ncia",
        "color": "#ef4444",
        "icon": "shield"
      }
    }
  ]
}
```

#### `POST /api/reserves/[id]/movements`

Registra uma movimenta√ß√£o

**Request Body:**

```json
{
  "type": "deposit", // ou "withdraw"
  "amount": "1000",
  "date": "2024-01-15T00:00:00Z",
  "description": "Dep√≥sito mensal"
}
```

**Comportamento:**

- `deposit`: Adiciona o valor ao saldo atual
- `withdraw`: Subtrai o valor do saldo atual
- Valida saldo insuficiente em retiradas
- Atualiza automaticamente `currentAmount` da reserva

#### `DELETE /api/reserves/[id]/movements/[movementId]`

Exclui uma movimenta√ß√£o e reverte o saldo

## üì¶ Arquivos Criados

### Schemas

1. `/src/app/db/schemas/reserve-schema.ts` - Schema da tabela de reservas
2. `/src/app/db/schemas/reserve-movement-schema.ts` - Schema de movimenta√ß√µes

### APIs

3. `/src/app/api/reserves/route.ts` - GET e POST de reservas
4. `/src/app/api/reserves/[id]/route.ts` - GET, PUT, DELETE, PATCH individual
5. `/src/app/api/reserves/[id]/movements/route.ts` - GET e POST de movimenta√ß√µes
6. `/src/app/api/reserves/[id]/movements/[movementId]/route.ts` - DELETE de movimenta√ß√£o

### Servi√ßos

7. `/src/services/reserve-service.ts` - Servi√ßo para reservas
8. `/src/services/reserve-movement-service.ts` - Servi√ßo para movimenta√ß√µes

### Hooks

9. `/src/hooks/use-reserves.ts` - Hooks React Query para reservas
10. `/src/hooks/use-reserve-movements.ts` - Hooks para movimenta√ß√µes

### Componentes

11. `/src/components/reserve-card.tsx` - Card de exibi√ß√£o de reserva

### Atualiza√ß√µes

12. `/src/app/db/schemas/relations.ts` - Relacionamentos atualizados
13. `/src/app/db/schemas/index.ts` - Exports atualizados
14. `/src/lib/routes.ts` - Rotas adicionadas

### Migrations

15. `drizzle/0005_plain_husk.sql` - Migration aplicada no banco

## üé® Personaliza√ß√£o Visual

### √çcones Dispon√≠veis

```typescript
const icons = [
  'piggy-bank',
  'wallet',
  'shield',
  'plane',
  'trending-up',
  'shopping-cart',
  'home',
  'car',
  'heart',
  'gift',
  'graduation-cap',
  'briefcase',
  'smartphone',
  'laptop',
  'droplet',
  'zap',
]
```

### Cores Dispon√≠veis

- Vermelho: `#ef4444`
- Laranja: `#f97316`
- Amarelo: `#f59e0b`
- Verde: `#10b981`
- Azul: `#3b82f6`
- √çndigo: `#6366f1`
- Roxo: `#8b5cf6`
- Rosa: `#ec4899`
- Cinza: `#6b7280`

## üîê Seguran√ßa e Permiss√µes

### Verifica√ß√µes Implementadas

1. **Criar/Editar Reservas**: Requer permiss√£o de Editor ou Owner no espa√ßo
2. **Visualizar Reservas**: Requer qualquer acesso ao espa√ßo (Owner, Editor ou Viewer)
3. **Movimenta√ß√µes**: Mesmo controle das reservas
4. **Exclus√£o**: Cascade delete configurado - ao excluir reserva, remove movimenta√ß√µes

### Valida√ß√µes

- ‚úÖ Saldo insuficiente em retiradas
- ‚úÖ Valores num√©ricos positivos
- ‚úÖ Datas obrigat√≥rias
- ‚úÖ Cores em formato hexadecimal
- ‚úÖ IDs UUID v√°lidos

## üí° Exemplos de Uso

### 1. Criar Reserva de Emerg√™ncia

```typescript
const { mutateAsync } = useCreateReserve()

await mutateAsync({
  name: 'Emerg√™ncia',
  description: 'Fundo para imprevistos',
  targetAmount: '10000',
  currentAmount: '0',
  color: '#ef4444',
  icon: 'shield',
  spaceId: 'space-uuid',
})
```

### 2. Registrar Dep√≥sito

```typescript
const { mutateAsync } = useCreateReserveMovement(spaceId)

await mutateAsync({
  type: 'deposit',
  amount: '500',
  date: new Date(),
  description: 'Dep√≥sito mensal',
  reserveId: 'reserve-uuid',
  userId: 'user-uuid',
})
// Saldo atual: 0 ‚Üí 500
```

### 3. Registrar Retirada

```typescript
await mutateAsync({
  type: 'withdraw',
  amount: '200',
  date: new Date(),
  description: 'Pagamento de conta',
  reserveId: 'reserve-uuid',
  userId: 'user-uuid',
})
// Saldo atual: 500 ‚Üí 300
```

## üìä Recursos de UI

### ReserveCard Component

- Exibe nome, descri√ß√£o e √≠cone colorido
- Mostra saldo atual formatado em BRL
- Progress bar quando tem meta definida
- Indicador de porcentagem atingida
- Badge de status (Ativa/Inativa)
- Menu de a√ß√µes (Editar, Adicionar Movimenta√ß√£o, Excluir)
- Dialogo de confirma√ß√£o para exclus√£o

## ‚úÖ Status da Implementa√ß√£o

- ‚úÖ **Backend Completo** - Schemas, APIs, valida√ß√µes
- ‚úÖ **Servi√ßos** - Services e hooks React Query
- ‚úÖ **Migrations** - Banco de dados atualizado
- ‚úÖ **Componentes** - Todos os componentes implementados
- ‚úÖ **P√°ginas** - Todas as p√°ginas criadas e funcionais
- ‚úÖ **Formul√°rios** - Formul√°rios de reserva e movimenta√ß√£o
- ‚úÖ **Menu de Navega√ß√£o** - Link adicionado ao sidebar

## üéâ Sistema 100% Funcional!

O sistema de reservas est√° completamente implementado e pronto para uso!

### Componentes Implementados

1. **ReserveCard** - Card de exibi√ß√£o de reserva com progresso
2. **ReserveForm** - Formul√°rio para criar/editar reservas
3. **ReservesGrid** - Grid responsivo de cards
4. **ReservesSummary** - Resumo estat√≠stico das reservas
5. **ReserveMovementForm** - Formul√°rio de movimenta√ß√µes
6. **ReserveMovementsTable** - Tabela de hist√≥rico

### P√°ginas Implementadas

1. **/admin/reserves** - Listagem de reservas com resumo
2. **/admin/reserves/new** - Criar nova reserva
3. **/admin/reserves/[id]/edit** - Editar reserva existente
4. **/admin/reserves/[id]/movements** - Gerenciar movimenta√ß√µes

### Navega√ß√£o

- Menu lateral inclui link "Reservas" com √≠cone de porquinho (PiggyBank)
- Todas as p√°ginas possuem navega√ß√£o intuitiva com bot√µes de voltar
- Dialogs para a√ß√µes r√°pidas (nova movimenta√ß√£o)

## üéØ Funcionalidades Completas

‚úÖ Criar, editar e excluir reservas  
‚úÖ Ativar/desativar reservas  
‚úÖ Registrar dep√≥sitos e retiradas  
‚úÖ Visualizar hist√≥rico de movimenta√ß√µes  
‚úÖ Acompanhar progresso de metas  
‚úÖ Saldo calculado automaticamente  
‚úÖ Valida√ß√£o de saldo insuficiente  
‚úÖ Revers√£o autom√°tica ao excluir movimenta√ß√£o  
‚úÖ Personaliza√ß√£o visual (cores e √≠cones)  
‚úÖ Resumo estat√≠stico geral  
‚úÖ Filtros e busca  
‚úÖ Integra√ß√£o completa com espa√ßos  
‚úÖ Controle de permiss√µes

## üöÄ Como Usar

### 1. Acessar Reservas

- No menu lateral, clique em "Reservas"
- Visualize o resumo geral e todas as suas reservas

### 2. Criar uma Reserva

- Clique em "Nova Reserva"
- Preencha: nome, descri√ß√£o (opcional), meta (opcional)
- Escolha uma cor e √≠cone
- Clique em "Criar Reserva"

### 3. Adicionar Movimenta√ß√£o

- No card da reserva, clique em "Adicionar Movimenta√ß√£o" no menu (‚ãÆ)
- OU abra a reserva e clique em "Nova Movimenta√ß√£o"
- Escolha o tipo (Dep√≥sito ou Retirada)
- Informe valor e data
- Adicione descri√ß√£o (opcional)
- Confirme

### 4. Gerenciar Movimenta√ß√µes

- Clique no card da reserva ou acesse via menu
- Visualize todo o hist√≥rico
- Exclua movimenta√ß√µes se necess√°rio (saldo √© ajustado automaticamente)

### 5. Editar Reserva

- No menu do card (‚ãÆ), clique em "Editar"
- Atualize as informa√ß√µes desejadas
- Salve as altera√ß√µes

## üéì Conceitos Utilizados

- **Drizzle ORM** - Modelagem de dados e migrations
- **Zod** - Valida√ß√£o de schemas
- **React Query** - Cache e sincroniza√ß√£o de dados
- **shadcn/ui** - Componentes UI (Dialog, Card, Form, Table, etc)
- **TypeScript** - Tipagem forte em todo o c√≥digo
- **RESTful API** - Padr√£o de APIs
- **Cascade Delete** - Integridade referencial
- **React Hook Form** - Gerenciamento de formul√°rios
- **Next.js 14** - App Router e Server Components

## üí° Melhorias Futuras (Opcional)

Sugest√µes para expandir o sistema:

- üìä **Gr√°ficos** - Visualiza√ß√£o da evolu√ß√£o do saldo ao longo do tempo
- üìÖ **Movimenta√ß√µes Recorrentes** - Agendar dep√≥sitos autom√°ticos
- üîî **Notifica√ß√µes** - Alertas ao atingir porcentagem da meta
- üì§ **Transfer√™ncias** - Mover dinheiro entre reservas
- üìë **Relat√≥rios** - Exportar hist√≥rico em PDF/Excel
- üè∑Ô∏è **Tags** - Categorizar movimenta√ß√µes
- üîç **Filtros Avan√ßados** - Busca por per√≠odo, tipo, valor
- üì± **Dashboard** - Vis√£o geral com cards interativos
- üéØ **Metas Compartilhadas** - Reservas colaborativas
- üìà **An√°lise Preditiva** - Proje√ß√£o de quando atingir√° a meta

## üìù Notas Importantes

1. **Saldo Autom√°tico**: O `currentAmount` √© calculado automaticamente com base nas movimenta√ß√µes
2. **Exclus√£o Reversa**: Ao excluir uma movimenta√ß√£o, o valor √© revertido no saldo
3. **Cores e √çcones**: Personaliz√°veis por reserva para f√°cil identifica√ß√£o visual
4. **Metas Opcionais**: Reservas podem ter ou n√£o uma meta definida
5. **Multi-Space**: Cada espa√ßo tem suas pr√≥prias reservas isoladas

---

**Status**: ‚úÖ Sistema 100% Completo e Funcional!  
**Data de Conclus√£o**: 15 de outubro de 2025  
**Implementado por**: GitHub Copilot
